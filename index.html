<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AION2 BOSS è¨ˆæ™‚å™¨ (å–®æ©Ÿç‰ˆ)</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <!-- 2. è¼‰å…¥ Babel (ç”¨æ–¼è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. è¨­å®š Import Map (å‘Šè¨´ç€è¦½å™¨å»å“ªè£¡æ‰¾ React å’Œ Firebase) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <!-- 4. ä¸»ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Clock, Skull, Plus, Trash2, Edit2, Save, X, RotateCcw, Swords, AlertCircle, Filter, Zap, Search, Check, Volume2, VolumeX, Download, Upload, Bot, History, ChevronRight, AlertTriangle, Cloud, CloudOff, Link, Copy, LogOut } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from 'firebase/firestore';

        // ==========================================
        // â–¼â–¼â–¼ è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase è¨­å®š â–¼â–¼â–¼
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyCFasj7ww7AnnQ2QYw0jyv79kJ4aFCf7QI",
  authDomain: "aion222.firebaseapp.com",
  projectId: "aion222",
  storageBucket: "aion222.firebasestorage.app",
  messagingSenderId: "988326833096",
  appId: "1:988326833096:web:6943b8c172c4c43b8eeefd",
  measurementId: "G-8R4VCLCYNC"
};
        // ==========================================

        // åˆå§‹åŒ– Firebase (å¦‚æœä½¿ç”¨è€…æ²’å¡«è¨­å®šï¼Œå°±æœƒç¶­æŒå–®æ©Ÿæ¨¡å¼ä¸å ±éŒ¯)
        let app = null;
        let auth = null;
        let db = null;
        const appId = 'standalone-app';

        try {
            if (YOUR_FIREBASE_CONFIG.apiKey && YOUR_FIREBASE_CONFIG.apiKey !== "è«‹è²¼ä¸Šæ‚¨çš„API_KEY") {
                app = initializeApp(YOUR_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized successfully");
            } else {
                console.warn("Firebase config not found. Running in offline mode.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        // --- BOSS è³‡æ–™ ---
        const GAME_DATA = [
            { id: 'e1', race: 'Elyos', name: "è¥¿å´å‡±å‹’è¾²", location: "åå¡”æ–¯æºªè°·", intervalNormal: 60, intervalEvent: 30, image: "ğŸº" },
            { id: 'e2', race: 'Elyos', name: "æ±å´æ¶…å‡±çˆ¾", location: "åå¡”æ–¯æºªè°·", intervalNormal: 60, intervalEvent: 30, image: "ğŸº" },
            { id: 'e3', race: 'Elyos', name: "è…æœ½çš„åº«å¡”çˆ¾", location: "è‰¾çˆ¾å€«æ²³æ²¼æ¾¤", intervalNormal: 60, intervalEvent: 30, image: "ğŸ§Ÿ" },
            { id: 'e4', race: 'Elyos', name: "ç››é–‹çš„æŸ¯æ—", location: "è‰¾çˆ¾å€«æ²³ä¸­æ¸¸", intervalNormal: 120, intervalEvent: 60, image: "ğŸŒº" },
            { id: 'e5', race: 'Elyos', name: "è­·è¡›å…µæç”˜ç‰¹", location: "è¦å¡å»¢å¢Ÿ", intervalNormal: 180, intervalEvent: 90, image: "ğŸ›¡ï¸" },
            { id: 'e6', race: 'Elyos', name: "ç‹‚é¬¥å£«åº«æ£®", location: "è¦å¡å»¢å¢Ÿ", intervalNormal: 240, intervalEvent: 120, image: "âš”ï¸" },
            { id: 'e7', race: 'Elyos', name: "ç¥­å¸é•·åŠ çˆ¾æ–°", location: "è¦å¡å»¢å¢Ÿ", intervalNormal: 240, intervalEvent: 120, image: "ğŸ”®" },
            { id: 'e8', race: 'Elyos', name: "è¡€ç ç‰™æ™®å¯§", location: "æ‰˜çˆ¾å·´æ–¯æ£®æ—", intervalNormal: 360, intervalEvent: 180, image: "ğŸ¦·" },
            { id: 'e9', race: 'Elyos', name: "æ†¤æ€’çš„è–©å‘‚", location: "æ‰˜çˆ¾å·´æ–¯æ£®æ—", intervalNormal: 360, intervalEvent: 180, image: "ğŸ˜¡" },
            { id: 'e10', race: 'Elyos', name: "å­¸è€…æ‹‰å…€æ‹‰", location: "é˜¿çˆ¾æ‹‰çƒéƒ¨è½", intervalNormal: 240, intervalEvent: 120, image: "ğŸ“œ" },
            { id: 'e11', race: 'Elyos', name: "è¿½æ“Šè€…å¡”å…€ç¾…", location: "é˜¿çˆ¾æ‹‰çƒéƒ¨è½", intervalNormal: 240, intervalEvent: 120, image: "ğŸƒ" },
            { id: 'e12', race: 'Elyos', name: "æ£®æ—æˆ°å£«çƒå‰Œå§†", location: "é˜¿çˆ¾æ‹‰çƒéƒ¨è½", intervalNormal: 480, intervalEvent: 240, image: "ğŸŒ³" },
            { id: 'e13', race: 'Elyos', name: "é»‘è‰²è§¸æ‰‹æ‹‰ç“¦", location: "é˜¿çˆ¾å¡”ç±³äºå³½è°·", intervalNormal: 480, intervalEvent: 240, image: "ğŸ¦‘" },
            { id: 'e14', race: 'Elyos', name: "å›æ•™è€…é›·æ‹‰", location: "é˜¿çˆ¾å¡”ç±³äºé«˜åŸ", intervalNormal: 360, intervalEvent: 180, image: "ğŸ‘º" },
            { id: 'e15', race: 'Elyos', name: "ç™¾å¤«é•·æˆ´ç±³ç¾…æ–¯", location: "é˜¿çˆ¾å¡”ç±³äºé«˜åŸ", intervalNormal: 480, intervalEvent: 240, image: "ğŸ‘®" },
            { id: 'e16', race: 'Elyos', name: "ç¥è–çš„å®‰è–©æ–¯", location: "é˜¿çˆ¾å¡”ç±³äºé«˜åŸ", intervalNormal: 720, intervalEvent: 360, image: "âœ¨" },
            { id: 'e17', race: 'Elyos', name: "æ²‰é»˜å¡”çˆ¾å¦", location: "é˜¿çˆ¾å¡”ç±³äºé«˜åŸå—éƒ¨", intervalNormal: 720, intervalEvent: 360, image: "ğŸ˜¶" },
            { id: 'e18', race: 'Elyos', name: "éˆé­‚æ”¯é…è€…å¡æ²™å¸•", location: "é˜¿çˆ¾å¡”ç±³äºé«˜åŸæ±éƒ¨", intervalNormal: 720, intervalEvent: 360, image: "ğŸ‘»" },
            { id: 'e19', race: 'Elyos', name: "æ”¶ç©«ç®¡ç†è€…è«å¤å¤«", location: "å¾·æ‹‰é‚£æ ½åŸ¹åœ°", intervalNormal: 360, intervalEvent: 180, image: "ğŸŒ¾" },
            { id: 'e20', race: 'Elyos', name: "ç›£è¦–å…µå™¨å…‹ç´è¨±", location: "å¾·æ‹‰é‚£æ ½åŸ¹åœ°", intervalNormal: 480, intervalEvent: 240, image: "ğŸ‘ï¸" },
            { id: 'e21', race: 'Elyos', name: "ç ”ç©¶å®˜å¡ç‰¹è˜­", location: "ç´å¸Œå¾·è»åœ˜è¦å¡", intervalNormal: 720, intervalEvent: 360, image: "ğŸ§ª" },
            { id: 'e22', race: 'Elyos', name: "å¹»å¤¢å¡è¥¿äº", location: "å¹»å½±ç¥åº­é™¢", intervalNormal: 720, intervalEvent: 360, image: "ğŸ¦‹" },
            { id: 'e23', race: 'Elyos', name: "è»åœ˜é•·æ‹‰æ ¼å¡”", location: "ç´…è‰²æ£®æ—", intervalNormal: 1440, intervalEvent: 720, image: "ğŸ‘‘" },
            { id: 'e24', race: 'Elyos', name: "æ°¸æ†å¡çˆ¾åäº", location: "æ°¸æ†ä¹‹å³¶", intervalNormal: 1440, intervalEvent: 720, image: "ğŸï¸" },
            { id: 'a1', race: 'Asmodian', name: "èåŒ–çš„é”ç´æ¨‚", location: "å¾·é›·å¾—å¥‡å®‰å¤±äº‹åœ°", intervalNormal: 60, intervalEvent: 30, image: "ğŸ« " },
            { id: 'a2', race: 'Asmodian', name: "é»‘è‰²æˆ°å£«é˜¿åŸƒå¾·", location: "ç„¡åå¢“åœ°", intervalNormal: 60, intervalEvent: 30, image: "âš”ï¸" },
            { id: 'a3', race: 'Asmodian', name: "å¿ å¯¦çš„æ‹‰å‰ç‰¹", location: "è–æ‰€ç›£è¦–å“¨æ‰€", intervalNormal: 60, intervalEvent: 30, image: "ğŸ•" },
            { id: 'a4', race: 'Asmodian', name: "ç‹‚æˆ°å£«ç“¦æ ¼", location: "è–æ‰€ç›£è¦–å“¨æ‰€", intervalNormal: 120, intervalEvent: 60, image: "ğŸ‘º" },
            { id: 'a5', race: 'Asmodian', name: "è¡€æˆ°å£«è˜­é‚£çˆ¾", location: "ç‘ªæ–¯è˜­æ£®æ—", intervalNormal: 180, intervalEvent: 90, image: "ğŸ©¸" },
            { id: 'a6', race: 'Asmodian', name: "æ•é£Ÿè€…åŠ çˆ¾æ¡‘", location: "ç‘ªæ–¯è˜­æ£®æ—", intervalNormal: 240, intervalEvent: 120, image: "ğŸ…" },
            { id: 'a7', race: 'Asmodian', name: "æ¬ºçè€…ç‰¹é‡Œå¾·", location: "çƒçˆ¾é€šæµ·å§†", intervalNormal: 240, intervalEvent: 120, image: "ğŸ¤¥" },
            { id: 'a8', race: 'Asmodian', name: "è—è‰²æ°´æ³¢å‡±åŒ¹é‚£", location: "æ·¨åŒ–ä¹‹æ£®", intervalNormal: 240, intervalEvent: 120, image: "ğŸŒŠ" },
            { id: 'a9', race: 'Asmodian', name: "æ²‰é»˜å¡”çˆ¾å¦", location: "æ·¨åŒ–ä¹‹æ£®", intervalNormal: 720, intervalEvent: 360, image: "ğŸ˜¶" },
            { id: 'a10', race: 'Asmodian', name: "åƒè¬€å®˜å‹’æ²™ç´", location: "å¾·æ‹‰é‚£å…‹åœ–æ–¯", intervalNormal: 360, intervalEvent: 180, image: "ğŸ“" },
            { id: 'a11', race: 'Asmodian', name: "ç¸½ç›£ç£å®˜åŠªå¡”", location: "å¾·æ‹‰é‚£å…‹åœ–æ–¯", intervalNormal: 240, intervalEvent: 120, image: "ğŸ‘€" },
            { id: 'a12', race: 'Asmodian', name: "åˆ¥å‹•éšŠé•·ä»¤å…‹æ–¯", location: "å·´æ–¯æ–çˆ¾ç‰¹å»¢å¢Ÿ", intervalNormal: 360, intervalEvent: 180, image: "ğŸ«¡" },
            { id: 'a13', race: 'Asmodian', name: "è¤»ç€†è€…è«¾å¸ƒé­¯å¾·", location: "å·´æ–¯æ–çˆ¾ç‰¹å»¢å¢Ÿ", intervalNormal: 480, intervalEvent: 240, image: "ğŸ•¸ï¸" },
            { id: 'a14', race: 'Asmodian', name: "äº¡é­‚åŸ·æ”¿å®˜äºå…‹å¸­æ­æ–¯", location: "å·´æ–¯æ–çˆ¾ç‰¹å»¢å¢Ÿ", intervalNormal: 480, intervalEvent: 240, image: "ğŸ‘»" },
            { id: 'a15', race: 'Asmodian', name: "ä¸­æ¯’çš„å“ˆè¿ªå€«", location: "æ³•å¤«å¥ˆç‰¹åŸ‹è—åœ°", intervalNormal: 360, intervalEvent: 180, image: "â˜ ï¸" },
            { id: 'a16', race: 'Asmodian', name: "éˆé­‚æ”¯é…è€…å¡æ²™å¸•", location: "æ³•å¤«å¥ˆç‰¹åŸ‹è—åœ°", intervalNormal: 720, intervalEvent: 360, image: "ğŸ‘»" },
            { id: 'a17', race: 'Asmodian', name: "è™•åˆ‘è€…å·´çˆ¾è¥¿æ©", location: "è‘›åˆ©å·´å¾·å³½è°·è¥¿éƒ¨", intervalNormal: 480, intervalEvent: 240, image: "ğŸª“" },
            { id: 'a18', race: 'Asmodian', name: "éƒ¨éšŠå…µå™¨å¤é­¯å¡”", location: "è‘›åˆ©å·´å¾·å³½è°·æ±éƒ¨", intervalNormal: 720, intervalEvent: 360, image: "ğŸ¤–" },
            { id: 'a19', race: 'Asmodian', name: "ç™¾æˆ°è€å°‡èˆ’æœ­å", location: "é»‘çˆªéƒ¨è½", intervalNormal: 360, intervalEvent: 180, image: "ğŸ‘´" },
            { id: 'a20', race: 'Asmodian', name: "ç¥•å‚³å¡é­¯å¡", location: "é»‘çˆªéƒ¨è½", intervalNormal: 480, intervalEvent: 240, image: "ğŸ¤" },
            { id: 'a21', race: 'Asmodian', name: "é»‘é—‡æ¯”ä¿®è²é”", location: "æ‹‰æ ¼å¡”è¦å¡", intervalNormal: 720, intervalEvent: 360, image: "ğŸŒ‘" },
            { id: 'a22', race: 'Asmodian', name: "è»åœ˜é•·æ‹‰æ ¼å¡”", location: "æ‹‰æ ¼å¡”è¦å¡", intervalNormal: 1440, intervalEvent: 720, image: "ğŸ‘‘" },
            { id: 'a23', race: 'Asmodian', name: "æ•éŠ³çš„æ•˜æ‹‰å…‹", location: "å› æ´¾åœ–è¥¿å§†å»£å ´", intervalNormal: 720, intervalEvent: 360, image: "ğŸ€" },
            { id: 'a24', race: 'Asmodian', name: "ä¸æ»…å¡çˆ¾åäº", location: "ä¸æ»…ä¹‹å³¶", intervalNormal: 1440, intervalEvent: 720, image: "ğŸï¸" },
            { id: 'ab1', race: 'Abyss', name: "ç›£è¦–è€…å¡ä¼Šæ‹‰", location: "è‰¾é›·ä¿®è—å¡”ä¸‹å±¤", intervalNormal: 60, intervalEvent: 60, image: "ğŸ‘ï¸" },
            { id: 'ab2', race: 'Abyss', name: "ç²¾éˆç‹é˜¿æ ¼ç¾…", location: "å¸ŒåŸƒçˆ¾ä¹‹ç¿¼ç¾¤å³¶", intervalNormal: 1440, intervalEvent: 720, image: "ğŸ§š" },
        ];

        const INITIAL_BOSSES = GAME_DATA.map(boss => ({
            ...boss,
            nextSpawn: null,
            lastKill: null
        }));

        function App() {
            const [bosses, setBosses] = useState(() => {
                const saved = localStorage.getItem('aion2-bosses-v2');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return INITIAL_BOSSES.map(initBoss => {
                        const savedBoss = parsed.find(p => p.id === initBoss.id);
                        return savedBoss ? { ...initBoss, nextSpawn: savedBoss.nextSpawn, lastKill: savedBoss.lastKill } : initBoss;
                    });
                }
                return INITIAL_BOSSES;
            });

            // State
            const [user, setUser] = useState(null);
            const [roomCode, setRoomCode] = useState(() => localStorage.getItem('aion2-room-code') || '');
            const [isConnected, setIsConnected] = useState(false);
            const [currentTime, setCurrentTime] = useState(Date.now());
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSyncModalOpen, setIsSyncModalOpen] = useState(false);
            const [editingBoss, setEditingBoss] = useState(null);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, type: 'confirm', message: '', onConfirm: null });

            // Settings
            const [isEventMode, setIsEventMode] = useState(() => localStorage.getItem('aion2-event-mode') === 'true');
            const [isSoundEnabled, setIsSoundEnabled] = useState(() => localStorage.getItem('aion2-sound-enabled') !== 'false');
            const [isAutoKillEnabled, setIsAutoKillEnabled] = useState(() => localStorage.getItem('aion2-auto-kill') === 'true');
            
            // UI
            const [ignoredEvents, setIgnoredEvents] = useState({});
            const [selectedRaces, setSelectedRaces] = useState(['Elyos', 'Asmodian', 'Abyss']); 
            const [searchQuery, setSearchQuery] = useState('');
            const [formData, setFormData] = useState({ name: '', location: '', intervalNormal: 60, intervalEvent: 30, image: 'ğŸ’€', race: 'Elyos' });
            const [syncInputCode, setSyncInputCode] = useState('');

            const fileInputRef = useRef(null);
            const alertedSpawnsRef = useRef(new Map());

            // --- Auth & Sync ---
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => { await signInAnonymously(auth); };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !roomCode || !db) { setIsConnected(false); return; }
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.bosses) setBosses(data.bosses);
                        if (typeof data.isEventMode === 'boolean') setIsEventMode(data.isEventMode);
                        setIsConnected(true);
                    } else { setIsConnected(true); }
                }, (error) => { console.error("Sync Error:", error); setIsConnected(false); });
                return () => unsubscribe();
            }, [user, roomCode]);

            const saveDataToCloud = async (newBosses, newEventMode) => {
                if (!user || !roomCode || !db) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode);
                    await setDoc(docRef, { bosses: newBosses, isEventMode: newEventMode, lastUpdated: Date.now(), updatedBy: user.uid }, { merge: true });
                } catch (e) { console.error("Save failed:", e); }
            };

            const updateBosses = (newBosses) => {
                setBosses(newBosses);
                if (isConnected) { saveDataToCloud(newBosses, isEventMode); } 
                else { localStorage.setItem('aion2-bosses-v2', JSON.stringify(newBosses)); }
            };

            const updateEventMode = (newMode) => {
                setIsEventMode(newMode);
                if (isConnected) { saveDataToCloud(bosses, newMode); } 
                else { localStorage.setItem('aion2-event-mode', newMode); }
            };

            useEffect(() => {
                if (!isConnected) { localStorage.setItem('aion2-bosses-v2', JSON.stringify(bosses)); localStorage.setItem('aion2-event-mode', isEventMode); }
                localStorage.setItem('aion2-sound-enabled', isSoundEnabled);
                localStorage.setItem('aion2-auto-kill', isAutoKillEnabled);
                localStorage.setItem('aion2-room-code', roomCode);
            }, [bosses, isEventMode, isSoundEnabled, isAutoKillEnabled, roomCode, isConnected]);

            // --- Handlers & Logic ---
            const playAlertSound = () => {
                if (!isSoundEnabled) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime); osc.frequency.setValueAtTime(587.33, ctx.currentTime + 0.15);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start(); osc.stop(ctx.currentTime + 0.6);
                } catch (e) { console.error(e); }
            };

            const getInterval = (boss) => isEventMode ? boss.intervalEvent : boss.intervalNormal;

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = Date.now();
                    setCurrentTime(now);
                    if (isSoundEnabled) {
                        bosses.forEach(boss => {
                            if (boss.nextSpawn) {
                                const timeLeft = boss.nextSpawn - now;
                                if (timeLeft <= 180000 && timeLeft > 178000) {
                                    const lastAlerted = alertedSpawnsRef.current.get(boss.id);
                                    if (lastAlerted !== boss.nextSpawn) { playAlertSound(); alertedSpawnsRef.current.set(boss.id, boss.nextSpawn); }
                                }
                            }
                        });
                    }
                    if (isAutoKillEnabled) {
                        let hasChanges = false;
                        const newBosses = bosses.map(boss => {
                            if (boss.nextSpawn && now > boss.nextSpawn + 15000) {
                                hasChanges = true;
                                const interval = isEventMode ? boss.intervalEvent : boss.intervalNormal;
                                return { ...boss, lastKill: boss.nextSpawn, nextSpawn: boss.nextSpawn + (interval * 60 * 1000), killType: 'auto' };
                            }
                            return boss;
                        });
                        if (hasChanges) updateBosses(newBosses);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [bosses, isSoundEnabled, isAutoKillEnabled, isEventMode, isConnected]);

            const showConfirm = (message, onConfirm) => setConfirmModal({ isOpen: true, type: 'confirm', message, onConfirm });
            const showAlert = (message) => setConfirmModal({ isOpen: true, type: 'alert', message, onConfirm: () => setConfirmModal(prev => ({...prev, isOpen: false})) });

            const handleDisconnect = () => showConfirm("ç¢ºå®šè¦é€€å‡ºæˆ¿é–“å—ï¼Ÿ\nè³‡æ–™å°‡ä¿ç•™åœ¨æœ¬åœ°ã€‚", () => { setRoomCode(''); setIsConnected(false); setIsSyncModalOpen(false); showAlert("å·²åˆ‡æ›å›å–®æ©Ÿæ¨¡å¼ã€‚"); });
            const handleConnectRoom = () => { if (!syncInputCode.trim()) return; setRoomCode(syncInputCode.trim()); setIsSyncModalOpen(false); };
            const copyRoomCode = () => { if(roomCode) { navigator.clipboard.writeText(roomCode); alert("å·²è¤‡è£½"); } };

            const handleKill = (id) => {
                const now = Date.now();
                const newBosses = bosses.map(b => b.id === id ? { ...b, lastKill: now, nextSpawn: now + (getInterval(b) * 60 * 1000), killType: 'manual' } : b);
                updateBosses(newBosses);
            };

            const handleQuickTimeInput = (id, e) => {
                if (e.type === 'keydown' && e.key !== 'Enter') return;
                const value = e.target.value.trim(); if (!value) return;
                const cleanVal = value.replace(/[^0-9]/g, ''); if (!/^[0-9]{3,6}$/.test(cleanVal)) return;
                let h, m, s = 0;
                if (cleanVal.length === 3) { h = parseInt(cleanVal.substring(0, 1)); m = parseInt(cleanVal.substring(1, 3)); }
                else if (cleanVal.length === 4) { h = parseInt(cleanVal.substring(0, 2)); m = parseInt(cleanVal.substring(2, 4)); }
                else if (cleanVal.length === 5) { h = parseInt(cleanVal.substring(0, 1)); m = parseInt(cleanVal.substring(1, 3)); s = parseInt(cleanVal.substring(3, 5)); }
                else { h = parseInt(cleanVal.substring(0, 2)); m = parseInt(cleanVal.substring(2, 4)); s = parseInt(cleanVal.substring(4, 6)); }
                if (h < 0 || h > 23 || m < 0 || m > 59 || s < 0 || s > 59) { showAlert("æ™‚é–“æ ¼å¼éŒ¯èª¤"); e.target.value = ''; return; }
                const now = new Date(); const kDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s); const kTime = kDate.getTime();
                const newBosses = bosses.map(b => b.id === id ? { ...b, lastKill: kTime, nextSpawn: kTime + (getInterval(b) * 60 * 1000), killType: 'manual' } : b);
                updateBosses(newBosses); e.target.value = ''; if(e.type === 'keydown') e.target.blur();
            };

            const handleReset = (id) => showConfirm("é‡ç½®è¨ˆæ™‚ï¼Ÿ", () => updateBosses(bosses.map(b => b.id === id ? { ...b, nextSpawn: null, lastKill: null } : b)));
            const handleRespawnAll = () => showConfirm("âš ï¸ è¨­å®šç‚ºã€Œå…¨éƒ¨é‡ç”Ÿã€ï¼Ÿ\næ‰€æœ‰ BOSS å°‡æ¨™è¨˜ç‚ºå·²é‡ç”Ÿã€‚", () => {
                const now = Date.now();
                updateBosses(bosses.map(b => ({ ...b, lastKill: null, nextSpawn: now, killType: null })));
                setIgnoredEvents({}); alertedSpawnsRef.current.clear();
            });
            const handleDelete = (id) => showConfirm("åˆªé™¤æ­¤ BOSSï¼Ÿ", () => updateBosses(bosses.filter(b => b.id !== id)));
            const handleIgnoreRecent = (boss) => {
                const isSpawned = boss.nextSpawn && boss.nextSpawn <= currentTime;
                const t = isSpawned ? boss.nextSpawn : boss.lastKill;
                if (t) setIgnoredEvents(prev => ({ ...prev, [boss.id]: t }));
            };
            const handleIgnoreAllRecent = () => showConfirm("å¿½ç•¥ç›®å‰æ‰€æœ‰é€šçŸ¥ï¼Ÿ", () => {
                const newIg = {};
                recentBosses.forEach(b => {
                    const isSpawned = b.nextSpawn && b.nextSpawn <= currentTime;
                    const t = isSpawned ? b.nextSpawn : b.lastKill;
                    if (t) newIg[b.id] = t;
                });
                setIgnoredEvents(prev => ({ ...prev, ...newIg }));
            });

            // Filtering & Sorting
            const recentBosses = bosses.filter(b => {
                const isSpawned = b.nextSpawn && b.nextSpawn <= currentTime;
                const isAutoKilledRecently = b.lastKill && (currentTime - b.lastKill < 5 * 60 * 1000) && b.killType === 'auto';
                if (!isSpawned && !isAutoKilledRecently) return false;
                const t = isSpawned ? b.nextSpawn : b.lastKill;
                if (ignoredEvents[b.id] === t) return false;
                return true;
            }).sort((a, b) => {
                const aS = a.nextSpawn <= currentTime; const bS = b.nextSpawn <= currentTime;
                if (aS && !bS) return -1; if (!aS && bS) return 1;
                return (bS ? b.nextSpawn : b.lastKill) - (aS ? a.nextSpawn : a.lastKill);
            });

            const filteredBosses = bosses.filter(b => selectedRaces.includes(b.race) && (!searchQuery || b.name.includes(searchQuery) || b.location.includes(searchQuery))).sort((a, b) => {
                if (!a.nextSpawn && !b.nextSpawn) return a.id.localeCompare(b.id);
                if (!a.nextSpawn) return 1; if (!b.nextSpawn) return -1;
                return a.nextSpawn - b.nextSpawn;
            });

            const toggleRace = (r) => setSelectedRaces(p => p.includes(r) ? p.filter(x => x !== r) : [...p, r]);
            const selectAllRaces = () => setSelectedRaces(['Elyos', 'Asmodian', 'Abyss']);
            const handleExport = () => {
                const blob = new Blob([JSON.stringify({ version: '2.0', timestamp: Date.now(), bosses, isEventMode, isSoundEnabled, isAutoKillEnabled }, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `aion2-backup.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };
            const handleImportClick = () => fileInputRef.current?.click();
            const handleFileChange = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try { const d = JSON.parse(ev.target.result); if (!Array.isArray(d.bosses)) throw new Error(); showConfirm(`åŒ¯å…¥ ${d.bosses.length} ç­†è³‡æ–™ï¼Ÿ`, () => { updateBosses(d.bosses); if (typeof d.isEventMode === 'boolean') updateEventMode(d.isEventMode); showAlert("åŒ¯å…¥æˆåŠŸï¼"); }); } catch { showAlert("åŒ¯å…¥å¤±æ•—"); } e.target.value = '';
                }; reader.readAsText(file);
            };
            const handleSaveBoss = (e) => {
                e.preventDefault();
                if (editingBoss) updateBosses(bosses.map(b => b.id === editingBoss.id ? { ...b, ...formData, nextSpawn: b.lastKill ? b.lastKill + (isEventMode ? formData.intervalEvent : formData.intervalNormal) * 60000 : null } : b));
                else updateBosses([...bosses, { ...formData, id: Date.now(), nextSpawn: null, lastKill: null }]);
                setIsModalOpen(false);
            };
            const openModal = (b = null) => {
                setEditingBoss(b);
                setFormData(b ? { ...b, intervalEvent: b.intervalEvent || b.intervalNormal } : { name: '', location: '', intervalNormal: 60, intervalEvent: 30, image: 'ğŸ’€', race: 'Elyos' });
                setIsModalOpen(true);
            };

            const formatTime = (ms) => {
                if (ms <= 0) return "å·²é‡ç”Ÿ";
                const totalSeconds = Math.floor(ms / 1000);
                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };
            const formatAbsTime = (ts) => {
                if (!ts) return "--:--";
                const d = new Date(ts);
                const s = d.getSeconds();
                return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}${s > 0 ? ':' + s.toString().padStart(2, '0') : ''}`;
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 font-sans pb-20">
                    <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-20 shadow-lg">
                        <div className="max-w-6xl mx-auto px-4 py-3">
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-indigo-600 rounded-lg shadow-lg"><Swords size={20} className="text-white" /></div>
                                    <div><h1 className="text-lg font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">AION2 BOSS è¨ˆæ™‚å™¨</h1><p className="text-xs text-slate-400 flex items-center gap-1 font-mono">{isConnected ? <span className="text-green-400 flex items-center gap-1"><Cloud size={10}/> {roomCode}</span> : <span className="text-slate-500 flex items-center gap-1"><CloudOff size={10}/> å–®æ©Ÿ</span>} | <Clock size={10} /> {new Date(currentTime).toLocaleTimeString()}</p></div>
                                </div>
                                <div className="flex gap-2 items-center">
                                    <button onClick={() => setIsSyncModalOpen(true)} className={`p-2 rounded-lg transition-colors shadow-md ${isConnected ? 'bg-green-600/20 text-green-400 border border-green-500/30' : 'bg-slate-700 hover:bg-slate-600 text-sky-400'}`}><Cloud size={20} /></button>
                                    {isConnected && <button onClick={handleDisconnect} className="bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 p-2 rounded-lg" title="é€€å‡º"><LogOut size={20} /></button>}
                                    <div className="w-[1px] h-6 bg-slate-600 mx-1"></div>
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                    <button onClick={handleImportClick} className="bg-slate-700 text-slate-300 p-2 rounded-lg" title="åŒ¯å…¥"><Upload size={20} /></button>
                                    <button onClick={handleExport} className="bg-slate-700 text-slate-300 p-2 rounded-lg" title="åŒ¯å‡º"><Download size={20} /></button>
                                    <div className="w-[1px] h-6 bg-slate-600 mx-1"></div>
                                    <button onClick={handleRespawnAll} className="bg-slate-700 text-red-400 p-2 rounded-lg" title="å…¨éƒ¨é‡ç”Ÿ"><RotateCcw size={20} /></button>
                                    <button onClick={() => openModal()} className="bg-slate-700 text-white p-2 rounded-lg" title="æ–°å¢"><Plus size={20} /></button>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row gap-3 items-center bg-slate-900/50 p-2 rounded-lg border border-slate-700/50">
                                <div className="relative w-full md:w-48"><Search size={14} className="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-500"/><input type="text" placeholder="æœå°‹..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-slate-800 border-none rounded-md py-1.5 pl-8 pr-2 text-xs text-slate-200 focus:ring-1 focus:ring-indigo-500"/></div>
                                <div className="h-4 w-[1px] bg-slate-700 hidden md:block"></div>
                                <div className="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 no-scrollbar"><button onClick={selectAllRaces} className={`px-3 py-1.5 rounded-md text-xs whitespace-nowrap transition-all border ${selectedRaces.length === 3 ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-400 border-transparent'}`}>å…¨éƒ¨</button>{['Elyos', 'Asmodian', 'Abyss'].map(r => (<button key={r} onClick={() => toggleRace(r)} className={`px-3 py-1.5 rounded-md text-xs whitespace-nowrap flex items-center gap-1 border ${selectedRaces.includes(r) ? 'bg-slate-700 text-white border-slate-500' : 'bg-slate-800 text-slate-500 border-transparent'}`}>{selectedRaces.includes(r) && <Check size={12} className="text-green-400"/>}{r === 'Elyos' ? 'å¤©æ—' : r === 'Asmodian' ? 'é­”æ—' : 'æ·±æ·µ'}</button>))}</div>
                                <div className="flex-1 hidden md:block"></div>
                                <button onClick={() => setIsAutoKillEnabled(!isAutoKillEnabled)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${isAutoKillEnabled ? 'bg-slate-700 text-rose-400 border-rose-500/30' : 'bg-slate-800 text-slate-500 border-transparent'}`} title={isAutoKillEnabled ? "è‡ªå‹•æ“Šæ®ºå·²é–‹å•Ÿ" : "è‡ªå‹•æ“Šæ®ºå·²é—œé–‰"}><Bot size={14} /></button>
                                <button onClick={() => setIsSoundEnabled(!isSoundEnabled)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${isSoundEnabled ? 'bg-slate-700 text-green-400 border-green-500/30' : 'bg-slate-800 text-slate-500 border-transparent'}`} title={isSoundEnabled ? "éŸ³æ•ˆé–‹å•Ÿ" : "éŸ³æ•ˆé—œé–‰"}>{isSoundEnabled ? <Volume2 size={14} /> : <VolumeX size={14} />}</button>
                                <button onClick={() => updateEventMode(!isEventMode)} className={`flex items-center gap-2 px-4 py-1.5 rounded-full text-xs font-bold transition-all border w-full md:w-auto justify-center ${isEventMode ? 'bg-amber-500/10 border-amber-500 text-amber-500 shadow' : 'bg-slate-800 border-slate-700 text-slate-400'}`}><Zap size={14} className={isEventMode ? 'fill-amber-500' : ''} />{isEventMode ? 'æ´»å‹•æœŸé–“' : 'ä¸€èˆ¬æœŸé–“'}</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6">
                        {recentBosses.length > 0 && (
                            <div className="mb-8 animate-[fadeIn_0.5s]">
                                <div className="flex items-center gap-2 mb-3 px-1"><History size={18} className="text-indigo-400" /><h2 className="text-sm font-bold text-slate-300">æœ€è¿‘å‹•æ…‹èˆ‡ä¿®æ­£</h2><div className="flex-1"></div><button onClick={handleIgnoreAllRecent} className="text-[10px] bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-400 px-2 py-1 rounded flex items-center gap-1 transition"><X size={10} /> å…¨éƒ¨å¿½ç•¥</button></div>
                                <div className="flex gap-3 overflow-x-auto pb-4 no-scrollbar snap-x">
                                    {recentBosses.map(boss => {
                                        const isSpawned = boss.nextSpawn && boss.nextSpawn <= currentTime;
                                        return (
                                            <div key={boss.id} className={`snap-start min-w-[200px] bg-slate-800 rounded-lg p-3 border shadow-lg flex flex-col justify-between ${isSpawned ? 'border-green-500/50' : 'border-slate-600'}`}>
                                                <div className="flex items-center gap-2 mb-2"><span className="text-xl">{boss.image}</span><div className="overflow-hidden"><div className="font-bold text-sm text-slate-200 truncate">{boss.name}</div><div className={`text-[10px] font-bold ${isSpawned ? 'text-green-400' : 'text-slate-400'}`}>{isSpawned ? 'ğŸŸ¢ å·²é‡ç”Ÿ' : 'ğŸ”´ å‰›æ“Šæ®º (è‡ªå‹•)'}</div></div></div>
                                                <div className="mt-auto flex flex-col gap-2">
                                                    {!isSpawned && <div className="relative"><input type="text" placeholder="ä¿®æ­£(123010)" maxLength={6} inputMode="numeric" className="w-full bg-slate-900 border border-slate-700 rounded py-1 px-2 text-xs text-center focus:border-indigo-500 outline-none" onKeyDown={(e) => handleQuickTimeInput(boss.id, e)} onBlur={(e) => handleQuickTimeInput(boss.id, e)}/><div className="text-[9px] text-slate-500 text-center mt-1">ä¸Šæ¬¡: {formatAbsTime(boss.lastKill)}</div></div>}
                                                    <div className="flex gap-1"><button onClick={() => handleKill(boss.id)} className={`flex-1 border rounded py-1 text-xs font-bold transition flex items-center justify-center gap-1 ${isSpawned ? 'bg-green-600/20 text-green-300 border-green-500/30' : 'bg-slate-700 text-slate-200 border-slate-600'}`}><Skull size={12}/> {isSpawned ? 'æ“Šæ®º' : 'é‡æ®º'}</button><button onClick={() => handleIgnoreRecent(boss)} className="flex-1 bg-slate-700 text-slate-400 border border-slate-600 rounded py-1 text-xs font-bold flex items-center justify-center gap-1"><X size={12}/> å¿½ç•¥</button></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filteredBosses.map(boss => {
                                const timeLeft = boss.nextSpawn ? boss.nextSpawn - currentTime : null;
                                const isSpawned = timeLeft !== null && timeLeft <= 0;
                                const isSoon = timeLeft !== null && timeLeft > 0 && timeLeft < 10 * 60 * 1000;
                                const isVerySoon = timeLeft !== null && timeLeft > 0 && timeLeft <= 3 * 60 * 1000;
                                const currentInterval = getInterval(boss);
                                let statusColor = "border-slate-700 bg-slate-800";
                                if (isSpawned) statusColor = "border-green-500 bg-slate-800 shadow-[0_0_15px_rgba(34,197,94,0.3)] order-first";
                                else if (isVerySoon) statusColor = "border-orange-500 bg-slate-800 shadow-[0_0_15px_rgba(249,115,22,0.3)] animate-pulse-slow";
                                else if (isSoon) statusColor = "border-yellow-500 bg-slate-800 shadow-[0_0_10px_rgba(234,179,8,0.2)]";

                                return (
                                    <div key={boss.id} className={`relative rounded-xl border-2 p-4 transition-all duration-300 ${statusColor}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex items-center gap-3"><div className="text-2xl bg-slate-700 w-10 h-10 flex items-center justify-center rounded-full shadow-inner">{boss.image}</div><div className="overflow-hidden"><h3 className="font-bold text-base text-slate-100 truncate">{boss.name}</h3><div className="flex items-center gap-2 text-[10px] text-slate-400"><span className={`px-1.5 py-0.5 rounded ${boss.race === 'Elyos' ? 'bg-sky-900/50 text-sky-300' : boss.race === 'Asmodian' ? 'bg-red-900/50 text-red-300' : 'bg-purple-900/50 text-purple-300'}`}>{boss.race === 'Elyos' ? 'å¤©' : boss.race === 'Asmodian' ? 'é­”' : 'æ·±'}</span><span className="truncate">ğŸ“{boss.location}</span></div></div></div>
                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(boss)} className="p-1 text-slate-500 hover:text-indigo-400"><Edit2 size={14} /></button><button onClick={() => handleDelete(boss.id)} className="p-1 text-slate-500 hover:text-red-400"><Trash2 size={14} /></button></div>
                                        </div>
                                        <div className="mb-4 bg-slate-900/50 rounded-lg p-2 text-center border border-slate-700/50 relative overflow-hidden">
                                            <div className="absolute top-1 right-2 text-[10px] text-slate-600 font-mono">{currentInterval}m</div>
                                            {boss.nextSpawn ? (
                                                <>
                                                    <div className={`text-xl font-mono font-bold tracking-wider my-1 ${isSpawned ? 'text-green-400 animate-pulse' : isVerySoon ? 'text-orange-400 animate-bounce' : isSoon ? 'text-yellow-400' : 'text-slate-200'}`}>{formatTime(timeLeft)}</div>
                                                    <div className="flex justify-between px-4 text-[10px] text-slate-500 border-t border-slate-800 pt-1 mt-1"><span>ä¸Šæ¬¡: {formatAbsTime(boss.lastKill)}</span><span>ä¸‹æ¬¡: {formatAbsTime(boss.nextSpawn)}</span></div>
                                                </>
                                            ) : (
                                                <div className="text-slate-500 py-3 flex flex-col items-center"><div className="flex items-center gap-1 text-xs opacity-60"><Clock size={12}/> é‡ç”Ÿ: {currentInterval} åˆ†</div><span className="text-[10px] mt-1">ç­‰å¾…æ“Šæ®º</span></div>
                                            )}
                                        </div>
                                        <div className="grid grid-cols-[1fr,auto] gap-2">
                                            <button onClick={() => handleKill(boss.id)} className={`h-9 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all text-sm ${isSpawned ? 'bg-gradient-to-r from-green-600 to-green-500 text-white shadow-green-900/20' : 'bg-gradient-to-r from-slate-700 to-slate-600 hover:from-slate-600 hover:to-slate-500 text-slate-200'}`}><Skull size={16} />{isSpawned ? "ç¢ºèªæ“Šæ®º" : "å‰›æ‰æ“Šæ®º"}</button>
                                            <div className="relative group"><input type="text" placeholder="123010" maxLength={6} inputMode="numeric" className="h-9 w-[80px] bg-slate-900 border border-slate-700 rounded-lg px-2 text-xs text-slate-300 focus:border-indigo-500 outline-none text-center" onKeyDown={(e) => handleQuickTimeInput(boss.id, e)} onBlur={(e) => handleQuickTimeInput(boss.id, e)}/><div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 whitespace-nowrap">1230=12:30 / 123010=12:30:10</div></div>
                                        </div>
                                        {boss.nextSpawn && <button onClick={() => handleReset(boss.id)} className="absolute bottom-4 right-4 translate-y-full opacity-0 hover:opacity-100 text-slate-600 hover:text-slate-400 transition text-[10px] flex items-center gap-1 mt-1"><RotateCcw size={10} /> é‡ç½®</button>}
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {isSyncModalOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm border border-slate-700 p-6">
                                <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Cloud size={24} className="text-indigo-400"/> é›²ç«¯åŒæ­¥</h2>
                                {!isConnected ? (
                                    <><input type="text" value={syncInputCode} onChange={(e) => setSyncInputCode(e.target.value)} placeholder="ä¾‹å¦‚: MyGuild2025" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-4 text-center font-mono font-bold"/><div className="flex gap-3"><button onClick={() => setIsSyncModalOpen(false)} className="flex-1 bg-slate-700 text-white py-2.5 rounded-lg">å–æ¶ˆ</button><button onClick={handleConnectRoom} className="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg">é€£ç·š</button></div></>
                                ) : (
                                    <><div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-4 text-center"><div className="text-green-400 font-bold mb-1 flex justify-center gap-2"><Check size={16}/> å·²é€£ç·š</div><div className="text-2xl font-mono font-bold text-white my-2">{roomCode}</div><button onClick={copyRoomCode} className="text-xs text-indigo-300 flex justify-center gap-1 mx-auto mt-2"><Copy size={12}/> è¤‡è£½ä»£ç¢¼</button></div><button onClick={handleDisconnect} className="w-full bg-red-600 text-white py-2.5 rounded-lg mb-3">ä¸­æ–·é€£ç·š</button><button onClick={() => setIsSyncModalOpen(false)} className="w-full bg-slate-700 text-white py-2.5 rounded-lg">é—œé–‰</button></>
                                )}
                            </div>
                        </div>
                    )}

                    {confirmModal.isOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm border border-slate-700 p-6">
                                <div className="flex flex-col items-center text-center gap-4">
                                    <div className="w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center text-yellow-500"><AlertTriangle size={28} /></div>
                                    <h3 className="text-lg font-bold text-white whitespace-pre-line">{confirmModal.message}</h3>
                                    <div className="flex w-full gap-3 mt-2">
                                        {confirmModal.type === 'confirm' && <><button onClick={() => setConfirmModal({ ...confirmModal, isOpen: false })} className="flex-1 bg-slate-700 text-slate-200 py-2.5 rounded-lg">å–æ¶ˆ</button><button onClick={() => { if (confirmModal.onConfirm) confirmModal.onConfirm(); setConfirmModal({ ...confirmModal, isOpen: false }); }} className="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg">ç¢ºèª</button></>}
                                        {confirmModal.type === 'alert' && <button onClick={() => setConfirmModal({ ...confirmModal, isOpen: false })} className="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg">é—œé–‰</button>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-800 rounded-xl shadow-2xl w-full max-w-md border border-slate-700">
                                <div className="flex justify-between items-center p-5 border-b border-slate-700"><h2 className="text-xl font-bold text-white">{editingBoss ? 'ç·¨è¼¯ BOSS' : 'æ–°å¢ BOSS'}</h2><button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-white"><X size={24} /></button></div>
                                <form onSubmit={handleSaveBoss} className="p-5 space-y-4">
                                    <div className="grid grid-cols-2 gap-4"><div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">ç¨®æ—</label><div className="flex bg-slate-900 p-1 rounded-lg">{['Elyos', 'Asmodian', 'Abyss'].map(r => (<button key={r} type="button" onClick={() => setFormData({...formData, race: r})} className={`flex-1 py-1.5 text-xs rounded-md ${formData.race === r ? 'bg-slate-700 text-white' : 'text-slate-500'}`}>{r}</button>))}</div></div><div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">åç¨±</label><input required type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none"/></div><div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">åœ°é»</label><input type="text" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none"/></div><div><label className="block text-xs text-slate-400 mb-1">ä¸€èˆ¬(åˆ†)</label><input required type="number" value={formData.intervalNormal} onChange={e => setFormData({...formData, intervalNormal: parseInt(e.target.value) || 0})} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none"/></div><div><label className="block text-xs text-amber-500">æ´»å‹•(åˆ†)</label><input required type="number" value={formData.intervalEvent} onChange={e => setFormData({...formData, intervalEvent: parseInt(e.target.value) || 0})} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none"/></div></div>
                                    <div><label className="block text-xs text-slate-400 mb-1">åœ–ç¤º</label><div className="flex gap-2 overflow-x-auto pb-2">{['ğŸº', 'ğŸ§Ÿ', 'ğŸŒº', 'ğŸ›¡ï¸', 'âš”ï¸', 'ğŸ”®', 'ğŸ¦·', 'ğŸ˜¡', 'ğŸ“œ', 'ğŸƒ', 'ğŸŒ³', 'ğŸ¦‘', 'ğŸ‘º', 'ğŸ‘®', 'âœ¨', 'ğŸ˜¶', 'ğŸ‘»', 'ğŸŒ¾', 'ğŸ‘ï¸', 'ğŸ§ª', 'ğŸ¦‹', 'ğŸ‘‘', 'ğŸï¸'].map(emoji => (<button key={emoji} type="button" onClick={() => setFormData({...formData, image: emoji})} className={`min-w-[40px] h-10 rounded-lg flex items-center justify-center text-xl transition ${formData.image === emoji ? 'bg-indigo-600 text-white scale-110' : 'bg-slate-700 text-slate-300'}`}>{emoji}</button>))}</div></div>
                                    <div className="pt-2 flex gap-3"><button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 bg-slate-700 text-white py-2 rounded-lg">å–æ¶ˆ</button><button type="submit" className="flex-1 bg-indigo-600 text-white py-2 rounded-lg shadow-lg"><Save size={18} /> å„²å­˜</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
